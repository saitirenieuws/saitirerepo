name: Auto Publish Satire
on:
  schedule:
    - cron: "15 6,8,10,13,15,18 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -r requirements.txt
      - run: python scripts/generate_site.py
      - run: |
          git config user.name "bot"
          git config user.email "bot@users.noreply.github.com"
          git add -A
          git commit -m "auto: new posts" || true
          git push

      - name: Sync to R2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: auto
          R2_ENDPOINT: https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com
        run: |
          aws s3 sync ./content s3://${{ secrets.R2_BUCKET }}/content \
            --endpoint-url "$R2_ENDPOINT" \
            --delete

          aws s3 sync ./public/images s3://${{ secrets.R2_BUCKET }}/public/images \
            --endpoint-url "$R2_ENDPOINT" \
            --delete

          aws s3 sync ./data s3://${{ secrets.R2_BUCKET }}/data \
            --endpoint-url "$R2_ENDPOINT" \
            --delete

          aws s3 sync ./assets s3://${{ secrets.R2_BUCKET }}/assets \
            --endpoint-url "$R2_ENDPOINT" \
            --delete

          aws s3 sync ./categorie s3://${{ secrets.R2_BUCKET }}/categorie \
            --endpoint-url "$R2_ENDPOINT" \
            --delete

          aws s3 sync ./search s3://${{ secrets.R2_BUCKET }}/search \
            --endpoint-url "$R2_ENDPOINT" \
            --delete

          aws s3 cp ./index.html s3://${{ secrets.R2_BUCKET }}/index.html \
            --endpoint-url "$R2_ENDPOINT"

          aws s3 cp ./404.html s3://${{ secrets.R2_BUCKET }}/404.html \
            --endpoint-url "$R2_ENDPOINT"

          aws s3 cp ./feed.xml s3://${{ secrets.R2_BUCKET }}/feed.xml \
            --endpoint-url "$R2_ENDPOINT"

          aws s3 cp ./sitemap.xml s3://${{ secrets.R2_BUCKET }}/sitemap.xml \
            --endpoint-url "$R2_ENDPOINT"

          aws s3 cp ./robots.txt s3://${{ secrets.R2_BUCKET }}/robots.txt \
            --endpoint-url "$R2_ENDPOINT"
